<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>How to fix do-agent exited with a return code 100 &#8211; Costin's place</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yet another network guy with a blog on the internet">
    <meta name="robots" content="all">
    <meta name="author" content="Costin Stefan">
    
    <meta name="keywords" content="">
    <link rel="canonical" href="https://costinstefan.eu/how-to-fix-do-agent-exited/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Costin's place" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202009161446" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="How to fix do-agent exited with a return code 100">
    <meta property="og:description" content="Yet another network guy with a blog on the internet">
    <meta property="og:url" content="https://costinstefan.eu/how-to-fix-do-agent-exited/">
    <meta property="og:site_name" content="Costin's place">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@costin_cz" />
        <meta name="twitter:creator" content="@costin_cz" />
    
    <meta name="twitter:title" content="How to fix do-agent exited with a return code 100" />
    <meta name="twitter:description" content="Yet another network guy with a blog on the internet" />
    <meta name="twitter:url" content="https://costinstefan.eu/how-to-fix-do-agent-exited/" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/icons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/icons/favicon-32x32.png" sizes="32x32">

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-5736067-3', 'auto');
       ga('send', 'pageview');
    </script>
    


  <!-- Begin Jekyll SEO tag v2.3.0 -->
<meta property="og:title" content="Installing Jekyll SEO Tag" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A Jekyll plugin to add metadata tags for search engines and social networks to better index and display your site’s content." />
<meta property="og:description" content="A Jekyll plugin to add metadata tags for search engines and social networks to better index and display your site’s content." />
<link rel="canonical" href="https://costinstefan.eu" />
<meta property="og:url" content="https://costinstefan.eu" />
<meta property="og:site_name" content="Costin Stefan's Blog" />
<script type="application/ld+json">
{"name":null,"description":"A Jekyll plugin to add metadata tags for search engines and social networks to better index and display your site’s content.","author":null,"@type":"WebPage","url":"https://jekyll.github.io/jekyll-seo-tag/installation/","image":null,"publisher":null,"headline":"Installing Jekyll SEO Tag","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
    <a href="/" style="font-size:32px">C<i class="dot-head">.</i>STIN</a>
      <nav class="site-nav">
        

    
    
    

    
        <a href="/about/">About</a>
    
    
    

    
    
        <a href="/contact/">Say Hello</a>
    
    

    
    
    
        <a href="/cv/">CV</a>
    

    
    
    

    
    
    

    
    
    

    
    
    

    
    
    

    
    
    

    
    
    

    
    
    

    
    
    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/caustee"></a>
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href=></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:site@costinstefan.eu"></a>
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/costinstefan"></a>
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>How to fix do-agent exited with a return code 100</h1>
  <span class="post-meta">Feb 16, 2020</span><br>
  
  <span class="post-meta small">
  
    4 min. read
  
  </span>
</div>

<article class="post-content">
  <p>So recently I’ve encountered the error in the subject. This came after 2 major changes (OS upgrade and PHP upgrade). So definitely it had to do with one of them. My money were on the first one.
I’ve looked around on the internet and the only thing I could see was this old article that had no solution: https://www.digitalocean.com/community/questions/do-agent-exited-with-a-return-code-100</p>

<p>So I knew I had to take the matters in my own hands. I’ve started by looking at that cron entry that was failing.
<code class="language-plaintext highlighter-rouge">run-parts: /etc/cron.daily/do-agent exited with return code 100</code></p>

<p>The cron itself was pretty simple, just a bash script.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:/etc/logrotate.d# cat /etc/cron.daily/do-agent
#!/bin/sh
/bin/bash /opt/digitalocean/do-agent/scripts/update.sh &gt;/dev/null 2&gt;&amp;1
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">update.sh</code> script is also very simple:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:/etc/logrotate.d# cat /opt/digitalocean/do-agent/scripts/update.sh
#!/bin/bash
# vim: noexpandtab

main() {
        # add some jitter to prevent overloading the packaging machines
        sleep $(( RANDOM % 900 ))

        export DEBIAN_FRONTEND="noninteractive"
        if command -v apt-get 2&amp;&gt;/dev/null; then
                apt-get -qq update -o Dir::Etc::SourceParts=/dev/null -o APT::Get::List-Cleanup=no -o Dir::Etc::SourceList="sources.list.d/digitalocean-agent.list"
                apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -qq install -y --only-upgrade do-agent
        elif command -v yum 2&amp;&gt;/dev/null; then
                yum -q -y --disablerepo="*" --enablerepo="digitalocean-agent" makecache
                yum -q -y update do-agent
        fi
}

main
root@server:/etc/logrotate.d#
</code></pre></div></div>

<p>I’ve ran the command manually and after a long (timeout?) period it exited with status code 100. So just like in my emails.</p>

<p>I went further on with my troubleshooting and added debug to bash and removed the redirect to /dev/null part. And this time I’ve noticed that there was no timeout, but just a random sleep that’s at the beginning of update.sh</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:/etc/apt/sources.list.d# time /bin/bash -x /opt/digitalocean/do-agent/scripts/update.sh
+ main
+ sleep 650
</code></pre></div></div>

<p>If you don’t want to wait 650 seconds then you can stop and start it again, hoping to get a shorter number, or just comment that part in the script. But I didn’t want to alter the script, just to fix it. So I chose to stop and re-start it till I get a shorter sleep timer.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:/etc/apt/sources.list.d# time /bin/bash -x /opt/digitalocean/do-agent/scripts/update.sh
+ main
+ sleep 812
^C

real    0m1.218s
user    0m0.004s
sys     0m0.000s
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:/etc/apt/sources.list.d# time /bin/bash -x /opt/digitalocean/do-agent/scripts/update.sh
+ main
+ sleep 13
+ export DEBIAN_FRONTEND=noninteractive
+ DEBIAN_FRONTEND=noninteractive
+ command -v apt-get 2
+ apt-get -qq update -o Dir::Etc::SourceParts=/dev/null -o APT::Get::List-Cleanup=no -o Dir::Etc::SourceList=sources.list.d/digitalocean-agent.list
+ apt-get -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold -qq install -y --only-upgrade do-agent
Setting up apache2 (2.4.29-1ubuntu4.11) ...
ERROR: Module reqtimeout does not exist!
dpkg: error processing package apache2 (--configure):
 installed apache2 package post-installation script subprocess returned error exit status 1
Errors were encountered while processing:
 apache2
E: Sub-process /usr/bin/dpkg returned an error code (1)

real    0m22.398s
user    0m8.120s
sys     0m0.876s
root@server:/etc/apt/sources.list.d# echo $?
100
</code></pre></div></div>

<p>Now I have it :) It seems that the update script fails due to some apache2 module missing. And this is normal, because I don’t have apache on my server.</p>

<p>So to fix it I just had to remove all apache-related packages from the machine. Which were installed by the latest PHP upgrade. So it wasn’t due to OS upgrade like I first suspected :)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:~# apt-get purge apache2*
Reading package lists... Done
Building dependency tree
Reading state information... Done
Note, selecting 'apache2-ssl-dev' for glob 'apache2*'
Note, selecting 'apache2.2-common' for glob 'apache2*'
Note, selecting 'apache2-suexec-pristine' for glob 'apache2*'
Note, selecting 'apache2-api-20120211' for glob 'apache2*'
Note, selecting 'apache2-data' for glob 'apache2*'
Note, selecting 'apache2-api-20120211-openssl1.1' for glob 'apache2*'
Note, selecting 'apache2-suexec' for glob 'apache2*'
Note, selecting 'apache2-bin' for glob 'apache2*'
Note, selecting 'apache2.2-bin' for glob 'apache2*'
Note, selecting 'apache2-dbg' for glob 'apache2*'
Note, selecting 'apache2-dev' for glob 'apache2*'
Note, selecting 'apache2-doc' for glob 'apache2*'
Note, selecting 'apache2-suexec-custom' for glob 'apache2*'
Note, selecting 'apache2' for glob 'apache2*'
Note, selecting 'apache2-utils' for glob 'apache2*'
Note, selecting 'apache2-mpm-itk' for glob 'apache2*'
Package 'apache2.2-bin' is not installed, so not removed
Package 'apache2.2-common' is not installed, so not removed
Note, selecting 'apache2-bin' instead of 'apache2-api-20120211'
Note, selecting 'apache2-bin' instead of 'apache2-api-20120211-openssl1.1'
Package 'apache2-mpm-itk' is not installed, so not removed
Package 'apache2-dbg' is not installed, so not removed
Package 'apache2-dev' is not installed, so not removed
Package 'apache2-doc' is not installed, so not removed
Package 'apache2-ssl-dev' is not installed, so not removed
Package 'apache2-suexec-custom' is not installed, so not removed
Package 'apache2-suexec-pristine' is not installed, so not removed
</code></pre></div></div>

<p>This time the script ended successfuly with status code 0.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@server:~# time /bin/bash -x /opt/digitalocean/do-agent/scripts/update.sh
+ main
+ sleep 61
+ export DEBIAN_FRONTEND=noninteractive
+ DEBIAN_FRONTEND=noninteractive
+ command -v apt-get 2
+ apt-get -qq update -o Dir::Etc::SourceParts=/dev/null -o APT::Get::List-Cleanup=no -o Dir::Etc::SourceList=sources.list.d/digitalocean-agent.list
+ apt-get -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold -qq install -y --only-upgrade do-agent

real    1m6.107s
user    0m4.184s
sys     0m0.552s
root@server:~# echo $?
0
</code></pre></div></div>

<p>Your error might be related to something else, but anyhow, in case you run into this sort of issues I hope this helps you speed-up the troubleshooting phase.</p>

</article>

<small>

  <div class="share-page">
  If you find this page interesting, feel free to share it:

  <div class="share-links">
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=How to fix do-agent exited with a return code 100&url=https://costinstefan.eu/how-to-fix-do-agent-exited/" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/shareArticle?url=https://costinstefan.eu/how-to-fix-do-agent-exited/&title=How to fix do-agent exited with a return code 100" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    
  </div>
</div>


</small>


  <div class="py2 post-footer">
<p>Costin Stefan</p>
</div>



<div id="latest-posts" class="row">



        <div class="col-12 col-md-6 mb-md-0 mb-3">
            <a href="https://costinstefan.eu/how-to-update-ntp-servers-on-hp-3par-7200c/">
                <img src="/" alt="How to change NTP server on HP 3PAR 7200c"
                     class="img-fluid">
        </div>





        <div class="col-12 col-md-6 mb-md-0 mb-3">
            <a href="https://costinstefan.eu/how-to-bypass-chrome-error/">
                <img src="/" alt="How to bypass Chrome error "Your connection is not private""
                     class="img-fluid">
        </div>







</div>




      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
     2020&nbsp;&nbsp; This website belongs to me. I may not be always right, but I have opinions and Internet access and I'm not afraid to use them! <br>
      Theme crafted with &lt;3 by <a href="https://johnotander.com">John Otander</a>.
    </small>
  </div>
</footer>


</body>
</html>
